# 作業履歴 - Railway デプロイ

**日付**: 2025-10-23
**担当**: Claude Code
**プロジェクト**: Hybrid RAG System - Railway デプロイメント

---

## 本日の作業概要

Hybrid RAG SystemのRailwayへのデプロイを実施しました。基本的なデプロイは完了しましたが、sentence_transformersのインストール問題が残っており、明日以降の対応が必要です。

---

## 作業内容

### 1. 現在の状態確認

**実施内容:**
- README.md、SETUP.md、DEPLOY.mdを確認
- 昨日（2025-10-22）までにPhase 1-4が完了していることを確認
- 本日の作業内容：ドキュメント整備（3ファイル更新）

**確認結果:**
- ✅ システム完成（Phase 4完了）
- ✅ ドキュメント整備完了
- ⏳ Railwayデプロイ未実施

---

### 2. Claude API Key取得

**実施内容:**
1. Anthropic Console（https://console.anthropic.com/）にアクセス
2. API Keys → Create Key
3. 新規APIキーを取得
4. キーを安全に保存

**結果:**
- ✅ Claude API Key取得完了（sk-ant-api...）

---

### 3. GitHubリポジトリ作成とプッシュ

**実施内容:**
1. ローカルでGitリポジトリ初期化
   ```bash
   git init
   git add .
   git commit -m "Initial commit: Hybrid RAG System"
   ```

2. GitHubリポジトリ作成
   - リポジトリ名: `hybrid-rag-system`
   - URL: https://github.com/kyuwatanabe/hybrid-rag-system.git

3. GitHubにプッシュ
   ```bash
   git remote add origin https://github.com/kyuwatanabe/hybrid-rag-system.git
   git push -u origin main
   ```

**結果:**
- ✅ 61ファイル、12,608行のコードをプッシュ完了
- ✅ .gitignoreで環境変数（.env）を除外
- ✅ コミットハッシュ: 51e7d11

**プッシュ内容:**
- Flaskアプリケーション（web_app_hybrid.py）
- RAGシステム（rag_system.py）
- FAQ管理システム（faq_manager.py、faq_searcher.py）
- ベクトルストア（vector_store.py）
- PDF処理（pdf_processor.py）
- テンプレート（templates/）
- 静的ファイル（static/）
- ドキュメント（README.md、SETUP.md、DEPLOY.md）
- 設定ファイル（requirements.txt、Procfile、railway.json、runtime.txt）

---

### 4. Railway初回デプロイ

**実施内容:**
1. Railway（https://railway.app/）にGitHubアカウントでログイン
2. New Project → Deploy from GitHub repo
3. リポジトリ選択: `kyuwatanabe/hybrid-rag-system`
4. 自動デプロイ開始

**デプロイ結果:**
- ✅ ビルド完了（828.21秒 = 約13.8分）
- ✅ プロジェクト名: grateful-libration
- ✅ 依存ライブラリインストール成功
  - Flask 2.3.0
  - PyTorch 2.9.0（899.8 MB）
  - FAISS-CPU 1.7.4
  - Anthropic 0.18.0
  - その他すべて

**ビルドログ（抜粋）:**
```
2025-10-23T13:54:36 [inf] === Successfully Built! ===
Build time: 828.21 seconds
```

---

### 5. 環境変数の設定

**実施内容:**
1. Railwayダッシュボード → grateful-libration → Variables
2. 環境変数追加:
   ```
   CLAUDE_API_KEY=sk-ant-api...
   ```
3. 自動再デプロイ開始

**結果:**
- ✅ 環境変数設定完了
- ✅ 自動再デプロイ完了

---

### 6. 公開ドメインの生成

**実施内容:**
1. web サービス → Settings → Public Networking
2. ドメイン自動生成確認

**結果:**
- ✅ ドメイン生成完了
- ✅ URL: https://web-production-16d7b.up.railway.app

---

### 7. アプリケーション動作確認

**実施内容:**
1. https://web-production-16d7b.up.railway.app にアクセス
2. 画面表示確認

**結果:**
- ✅ アプリケーション起動成功
- ✅ 「GFアメリカサポートデスク」画面が表示
- ⚠️ sentence_transformers警告が発生

**初回デプロイメントログ（抜粋）:**
```
2025-10-23T14:09:55 [inf] [WARNING] セマンティックモデルのロード失敗: No module named 'sentence_transformers'
2025-10-23T14:09:55 [inf] [WARNING] 文字列ベースの重複判定にフォールバックします
2025-10-23T14:09:55 [inf] FAQデータを0件読み込みました
2025-10-23T14:09:55 [inf] [STARTUP] CLAUDE_API_KEY is set
2025-10-23T14:09:55 [inf] * Serving Flask app 'web_app'
2025-10-23T14:09:55 [err] WARNING: This is a development server.
```

---

### 8. PDFファイルの配置とベクトルDB構築

**実施内容:**

#### 8.1 ローカル環境での準備
1. reference_docs/ フォルダ作成
   ```bash
   mkdir reference_docs
   ```

2. PDFファイルをコピー
   ```bash
   cp "米国ビザ申請の手引きVer.21..pdf" reference_docs/
   ```

3. ベクトルDB再構築
   ```bash
   python rebuild_vector_db.py
   ```

**処理結果:**
- ✅ PDFファイル: 米国ビザ申請の手引きVer.21..pdf
- ✅ ページ数: 158ページ（1.9MB）
- ✅ チャンク数: 386個 → 385個（重複除去後）
- ✅ 処理時間: 23.4秒
- ✅ ベクトルDB: vector_db/faiss_index.bin 作成完了

#### 8.2 GitHubへプッシュ
```bash
git add reference_docs/
git commit -m "Add reference PDF: 米国ビザ申請の手引きVer.21"
git push
```

**結果:**
- ✅ PDFファイルをGitHubにプッシュ完了
- ✅ コミットハッシュ: f08ecb9
- ⚠️ ベクトルDBは.gitignoreで除外（Railwayで再構築が必要）

---

### 9. sentence_transformers問題の修正

**問題発見:**
Railwayデプロイメントログで以下の警告を確認：
```
[WARNING] セマンティックモデルのロード失敗: No module named 'sentence_transformers'
```

**原因分析:**
- requirements.txtには記載あり（sentence-transformers==2.2.2）
- しかし、依存関係（torch、transformers）が明示されていない
- Railwayビルド時にインストールに失敗している可能性

**実施した修正:**

#### 9.1 requirements.txt の改善
```diff
# RAG System Dependencies

Flask==2.3.0
Flask-CORS==4.0.0
+gunicorn==21.2.0
PyMuPDF==1.23.0
sentence-transformers==2.2.2
faiss-cpu==1.7.4
anthropic==0.18.0
numpy==1.24.0
pandas==2.0.0
python-dotenv==1.0.0
requests==2.31.0
+torch>=2.0.0
+transformers>=4.30.0
```

**追加内容:**
- gunicorn: 本番環境用WSGIサーバー
- torch: sentence_transformersの依存関係を明示
- transformers: sentence_transformersの依存関係を明示

#### 9.2 Procfile の改善
```diff
-web: python web_app_hybrid.py
+web: gunicorn web_app_hybrid:app --bind 0.0.0.0:$PORT --workers 1 --timeout 120 --preload
```

**変更理由:**
- Flaskの開発サーバー → Gunicorn（本番環境用）
- workers=1: メモリ節約（Railway無料プラン対応）
- timeout=120: RAG生成に時間がかかるため
- preload: アプリを事前ロード

#### 9.3 GitHubへプッシュ
```bash
git add requirements.txt Procfile
git commit -m "Fix sentence_transformers and production server"
git push
```

**結果:**
- ✅ 修正をGitHubにプッシュ完了
- ✅ コミットハッシュ: c5738b0
- ⏳ Railway再デプロイ待ち

---

## 現在の状況

### ✅ 完了した項目

1. **GitHubリポジトリ作成**
   - URL: https://github.com/kyuwatanabe/hybrid-rag-system.git
   - 3回のコミット（51e7d11、f08ecb9、c5738b0）

2. **Railwayデプロイ**
   - プロジェクト名: grateful-libration
   - URL: https://web-production-16d7b.up.railway.app
   - 環境変数: CLAUDE_API_KEY設定済み

3. **アプリケーション起動**
   - 基本的な動作確認OK
   - 画面表示成功

4. **PDFファイル配置**
   - 米国ビザ申請の手引きVer.21..pdf（158ページ、1.9MB）
   - GitHubにプッシュ済み

5. **ローカル環境のベクトルDB構築**
   - 385チャンク生成完了

### ⏳ 未完了・継続作業

1. **Railway環境でのsentence_transformers問題**
   - 状態: 修正コミット済み（c5738b0）
   - 次回作業: 再デプロイ確認が必要
   - 期待結果: sentence_transformersが正常にロード
   - 確認方法: デプロイメントログで警告が消えることを確認

2. **Railway環境でのベクトルDB構築**
   - 状態: 未実施
   - 理由: vector_db/フォルダは.gitignoreで除外
   - 次回作業: Railway環境でベクトルDBを構築
   - 方法1: アプリ起動時の自動構築機能を実装
   - 方法2: Railway CLIで手動実行
   - 方法3: Railway Volumesで永続化

3. **FAQ生成**
   - 状態: 未実施
   - ウィンドウ数: 385個（ローカル確認済み）
   - 生成予定数: ユーザー希望次第（50-385件）
   - 所要時間: 約9-10秒/件
   - 次回作業: Railway環境でFAQ生成画面からFAQを生成

4. **本番環境の最終確認**
   - FAQ検索機能テスト
   - RAG生成機能テスト
   - 管理画面テスト
   - FAQ自動生成機能テスト

---

## 次回作業のチェックリスト

### 優先度：高

- [ ] Railwayで最新デプロイメント（c5738b0）を確認
  - Deploymentsタブでコミットハッシュを確認
  - まだ古いバージョンの場合は手動で再デプロイ

- [ ] デプロイメントログを確認
  - sentence_transformersの警告が消えているか
  - Gunicornが起動しているか
  - "development server"警告が消えているか

- [ ] Railway環境でベクトルDBを構築
  - 方法を選択（自動構築 or 手動実行）
  - 385チャンクが正常に構築されるか確認

### 優先度：中

- [ ] FAQ生成を実行
  - https://web-production-16d7b.up.railway.app/generate にアクセス
  - 生成数を決定（推奨: 50-100件から開始）
  - 生成進捗をモニタリング
  - 生成されたQ&Aの品質を確認

- [ ] 本番環境での動作テスト
  - FAQ検索テスト（類似度閾値: 0.85）
  - RAG生成テスト（Claude API経由）
  - 出典（ページ番号）表示確認
  - 管理画面（/admin）での承認・拒否機能テスト

### 優先度：低

- [ ] パフォーマンス最適化
  - 応答時間の測定
  - メモリ使用量の確認
  - Railway無料プランで動作するか確認

- [ ] ドキュメント更新
  - README.mdに実際のデプロイURL追加
  - DEPLOY.mdにトラブルシューティング追加

---

## 技術メモ

### Railway設定

**プロジェクト情報:**
- プロジェクト名: grateful-libration
- サービス名: web
- リージョン: Asia Southeast（推定）
- ビルダー: NIXPACKS

**環境変数:**
```
CLAUDE_API_KEY=sk-ant-api...（設定済み）
```

**推奨追加環境変数（オプション）:**
```
FLASK_ENV=production
FLASK_DEBUG=False
FAQ_THRESHOLD=0.85
TOP_K_CHUNKS=10
FINAL_CHUNKS=5
SIMILARITY_THRESHOLD=0.93
CHUNK_SIZE=800
CHUNK_OVERLAP=100
```

**リソース使用量:**
- ビルド時間: 約13-15分（初回）、5-10分（2回目以降）
- メモリ: 推定1-2GB（sentence_transformersモデル含む）
- ストレージ: 約3GB（依存ライブラリ + モデル）

### ファイル構成

**GitHubリポジトリ:**
```
hybrid-rag-system/
├── web_app_hybrid.py          # メインFlaskアプリ
├── hybrid_rag_system.py       # ハイブリッドRAGコア
├── rag_system.py              # RAGシステム
├── faq_searcher.py            # FAQ検索
├── faq_manager.py             # FAQ管理
├── pdf_processor.py           # PDF処理
├── vector_store.py            # ベクトルストア
├── requirements.txt           # 依存ライブラリ
├── Procfile                   # Railway起動コマンド
├── railway.json               # Railway設定
├── runtime.txt                # Pythonバージョン（3.11.6）
├── .env.example               # 環境変数サンプル
├── .gitignore                 # Git除外設定
├── README.md                  # プロジェクト概要
├── SETUP.md                   # セットアップガイド
├── DEPLOY.md                  # デプロイガイド
├── reference_docs/            # PDFファイル
│   └── 米国ビザ申請の手引きVer.21..pdf
├── templates/                 # Flaskテンプレート
│   ├── index_hybrid.html
│   ├── admin_hybrid.html
│   └── generate_faq.html
└── static/                    # 静的ファイル
    ├── css/
    └── js/
```

**除外ファイル（.gitignore）:**
- .env（APIキー含む）
- vector_db/（ベクトルDBファイル）
- venv/（仮想環境）
- __pycache__/（Pythonキャッシュ）
- *.log（ログファイル）

### 依存ライブラリ（requirements.txt）

**最新版（c5738b0）:**
```
Flask==2.3.0
Flask-CORS==4.0.0
gunicorn==21.2.0              # 追加
PyMuPDF==1.23.0
sentence-transformers==2.2.2
faiss-cpu==1.7.4
anthropic==0.18.0
numpy==1.24.0
pandas==2.0.0
python-dotenv==1.0.0
requests==2.31.0
torch>=2.0.0                  # 追加
transformers>=4.30.0          # 追加
```

---

## トラブルシューティング

### 発生した問題と解決策

#### 問題1: sentence_transformersがロードできない

**エラー:**
```
[WARNING] セマンティックモデルのロード失敗: No module named 'sentence_transformers'
```

**原因:**
- requirements.txtに記載はあるが、依存関係が不足
- torch、transformersが明示的にインストールされていない

**解決策:**
- requirements.txtに `torch>=2.0.0` と `transformers>=4.30.0` を追加
- コミット: c5738b0
- 状態: 修正済み、次回デプロイで確認予定

#### 問題2: 開発サーバーの警告

**警告:**
```
WARNING: This is a development server. Do not use it in a production deployment.
```

**原因:**
- Procfileで `python web_app_hybrid.py` を使用
- Flaskの開発サーバーを本番環境で使用している

**解決策:**
- gunicornを追加
- Procfileを変更: `gunicorn web_app_hybrid:app --bind 0.0.0.0:$PORT --workers 1 --timeout 120 --preload`
- コミット: c5738b0
- 状態: 修正済み、次回デプロイで確認予定

---

## 参考情報

### リンク

- **GitHub**: https://github.com/kyuwatanabe/hybrid-rag-system.git
- **Railway**: https://railway.app/dashboard
- **デプロイURL**: https://web-production-16d7b.up.railway.app
- **Anthropic Console**: https://console.anthropic.com/

### コミット履歴

1. **51e7d11** - Initial commit: Hybrid RAG System
   - 日時: 2025-10-23（1回目）
   - 内容: 全ファイル初回プッシュ（61ファイル、12,608行）

2. **f08ecb9** - Add reference PDF: 米国ビザ申請の手引きVer.21
   - 日時: 2025-10-23（2回目）
   - 内容: PDFファイル追加（reference_docs/）

3. **c5738b0** - Fix sentence_transformers and production server
   - 日時: 2025-10-23（3回目）
   - 内容: requirements.txt、Procfile修正

---

## 所感・メモ

### 成功した点

1. **スムーズなGitHub連携**
   - GitリポジトリからRailwayまで自動連携が正常に機能
   - プッシュ後の自動デプロイがスムーズ

2. **基本的なデプロイ成功**
   - 初回ビルドが約13分で完了
   - 環境変数設定後、アプリケーションが起動
   - 画面表示まで到達

3. **ドキュメント整備**
   - README.md、SETUP.md、DEPLOY.mdが充実
   - 次回作業の手順が明確

### 課題・改善点

1. **sentence_transformers問題**
   - 依存関係の明示が不足していた
   - requirements.txtの改善が必要だった
   - 次回デプロイで解決予定

2. **ベクトルDB構築**
   - Railway環境での構築方法が未確定
   - 自動構築の仕組みが必要
   - またはRailway Volumesでの永続化を検討

3. **デプロイフロー**
   - GitHubプッシュ後の自動デプロイが反映されない場合があった
   - 手動再デプロイの方法を把握する必要があった

### 次回への引き継ぎ事項

1. **最優先: 再デプロイ確認**
   - コミット c5738b0 が反映されているか確認
   - sentence_transformersの警告が消えているか確認

2. **ベクトルDB構築方法の決定**
   - 自動構築を実装するか
   - 手動構築でよいか
   - 永続化が必要か

3. **FAQ生成の実行**
   - 何件生成するか決定
   - 生成後の品質確認

---

**作成者**: Claude Code
**作成日時**: 2025-10-23
**ドキュメントバージョン**: 1.0
