# 作業履歴 - ウィンドウ情報追加とデプロイ修正

**日付**: 2025-10-24（深夜〜早朝）
**担当**: Claude Code
**プロジェクト**: Hybrid RAG System - ウィンドウ情報追加とRailway修正

---

## 作業サマリー

Railway デプロイのエラー修正とFAQ生成時のウィンドウ情報追跡機能を実装しました。現在、Railwayで最終デプロイがBuild中です。

---

## 実施した作業

### 1. Railway初回デプロイエラー修正（ModuleNotFoundError）

**問題:**
```
ModuleNotFoundError: No module named 'faq_system'
```

**原因:**
- `faq_system.py`が親ディレクトリにあり、リポジトリに含まれていなかった
- `web_app_hybrid.py`が`../faq_system/`からインポートしようとしていた

**実施した修正:**
1. `faq_system.py`を`rag_system/`ディレクトリにコピー
2. `web_app_hybrid.py`のインポートパスを修正（同一ディレクトリから）
3. コミット: `2ca2e21` - "Fix ModuleNotFoundError: Add faq_system.py to repository"

---

### 2. ベクトルDB自動構築機能の追加

**問題:**
- Railwayでは`vector_db/`がgitignoreされているため存在しない
- アプリ起動時にFileNotFoundErrorが発生する

**実施した修正:**

**新規ファイル:**
- `startup_init.py`: 起動時のベクトルDB自動構築スクリプト

**修正ファイル:**
- `vector_store.py`: ベクトルDBが存在しない場合に自動構築を試行

**動作:**
1. `vector_store.load_index()`実行時、ファイルがない場合を検知
2. `startup_init.check_and_build_vector_db()`を呼び出し
3. `reference_docs/`フォルダからPDFを検索
4. PDFを処理してベクトルDB構築（385チャンク）
5. 構築完了後、通常通りロード

**コミット:** `0d1f63f` - "Add auto-build vector database on startup"

---

### 3. ウィンドウ情報追跡機能の実装

**背景:**
- ユーザーから「生成されたFAQが第2章に偏っている気がする」との指摘
- どのページ範囲からFAQが生成されたか追跡できるようにする

**実施した修正:**

#### 3.1 faq_system.py
- `add_pending_qa()`に`window_info`パラメータを追加
- FAQ生成時にウィンドウ情報を記録:
  ```python
  faq["window_info"] = f"Q範囲: {window_pair['q_range']} / A範囲: {window_pair['a_range']} / 位置: {selected_position}"
  ```

#### 3.2 web_app_hybrid.py
- `add_pending_qa()`呼び出し時に`window_info`を渡す

#### 3.3 templates/review_pending.html
- 承認待ちFAQ画面にウィンドウ情報を表示:
  ```
  📍 ウィンドウ: Q範囲: 12500~13000 / A範囲: 12000~13500 / 位置: 12000
  ```

**効果:**
- どのページ範囲からFAQが生成されたか可視化
- 偏りを確認して未カバー領域を特定可能
- PDF全体のカバレッジを分析できる

**コミット:** `63309bf` - "Add window info tracking and fix PDF name display"

---

### 4. 「第2章」表示の修正

**問題:**
- UI上で「第2章.pdf」と表示されている箇所が多数存在
- 実際のPDFは「米国ビザ申請の手引きVer.21..pdf」（158ページ）

**実施した修正:**
- `templates/auto_generate_faq.html`: すべての「第2章.pdf」→「米国ビザ申請の手引き.pdf」に変更
- FAQ生成画面で正しいPDF名が表示される

**同じコミット:** `63309bf`

---

### 5. 構文エラー修正（1回目）

**問題:**
```
SyntaxError: invalid syntax. Perhaps you forgot a comma?
File "/app/web_app_hybrid.py", line 703
  window_info=faq.get("window_info", "")
              ^^^^^^^^^^^^^^^^^^^^^^^^^^
```

**原因:**
1. `window_info`パラメータの後にカンマがなかった
2. `question`パラメータが重複していた（2箇所）
3. 引数の順序が間違っていた

**実施した修正:**
- `web_app_hybrid.py` 703行目と844行目を修正
- カンマを追加、重複を削除、順序を修正

**コミット:** `ec4fb15` - "Fix SyntaxError: add missing commas and remove duplicate question parameter"

---

### 6. 構文エラー修正（2回目）

**問題:**
```
SyntaxError: f-string: unmatched '['
File "/app/faq_system.py", line 1529
  faq["window_info"] = f"Q範囲: {window_pair["q_range"]} / A範囲: {window_pair["a_range"]} / 位置: {selected_position}"
                                            ^^^^^^^
```

**原因:**
- f-string内でダブルクォートが衝突
- `window_pair["q_range"]`のダブルクォートがf-stringの外側のダブルクォートと衝突

**実施した修正:**
- f-string内の辞書アクセスをシングルクォートに変更:
  ```python
  # 修正前
  faq["window_info"] = f"Q範囲: {window_pair["q_range"]} ..."

  # 修正後
  faq["window_info"] = f"Q範囲: {window_pair['q_range']} ..."
  ```

**コミット:** `bfc7736` - "Fix f-string syntax error: use single quotes inside f-string"

---

## 現在の状況

### ✅ 完了した項目

1. **faq_system.py追加**: ModuleNotFoundError解決
2. **ベクトルDB自動構築**: 起動時に自動でPDFから構築
3. **ウィンドウ情報追跡**: FAQ生成時のページ範囲を記録
4. **「第2章」表示修正**: 正しいPDF名に変更
5. **構文エラー修正**: カンマ欠落とf-string引用符を修正
6. **GitHubプッシュ完了**: コミット `bfc7736`

### ⏳ 進行中の項目

1. **Railwayデプロイ**: Build中（コミット `bfc7736`）
   - 所要時間: 5-15分
   - ステータス: Building（確認時点）

---

## 次回作業時のチェックリスト

### 優先度：最高（必須確認）

- [ ] **Railwayデプロイ完了確認**
  - URL: https://railway.app/dashboard → grateful-libration → Deployments
  - コミット `bfc7736` のステータスが「Success」になっているか
  - 緑のチェックマークが表示されているか

- [ ] **Logsタブでエラーチェック**
  - エラーログがないか確認
  - 以下のログが表示されているか:
    ```
    [STARTUP] Checking vector database...
    ✓ Vector database built successfully!
    Total chunks: 385
    [INFO] ハイブリッドRAGシステムを初期化中...
    ```

- [ ] **アプリ起動確認**
  - URL: https://web-production-16d7b.up.railway.app
  - HTTP 200 OKが返ってくるか
  - 画面が正常に表示されるか

### 優先度：高（機能確認）

- [ ] **ベクトルDB構築確認**
  - Logsタブで以下を確認:
    - `Found 1 PDF file(s): 米国ビザ申請の手引きVer.21..pdf`
    - `Created 386 chunks`
    - `Kept 385 unique chunks`
    - `✓ Vector database built successfully!`
  - 構築時間: 3-5分程度（初回のみ）

- [ ] **FAQ生成テスト**
  - https://web-production-16d7b.up.railway.app/admin/auto_generate_faq にアクセス
  - 画面に「米国ビザ申請の手引き.pdf」と表示されているか（✓ 修正済み）
  - テストで3-5件のFAQを生成
  - 生成時間: 約10秒/FAQ

- [ ] **ウィンドウ情報表示確認**
  - FAQ生成後、https://web-production-16d7b.up.railway.app/admin/review にアクセス
  - 承認待ちFAQに以下の情報が表示されているか:
    ```
    📍 ウィンドウ: Q範囲: xxx~xxx / A範囲: xxx~xxx / 位置: xxx
    ```
  - 複数のFAQのウィンドウ位置を比較して偏りを確認

### 優先度：中（動作確認）

- [ ] **RAG検索機能テスト**
  - トップページで質問を入力:
    - 例: 「ビザの申請方法を教えてください」
    - 例: 「面接の予約はどうすればいいですか」
  - 回答が返ってくるか
  - 出典（ページ番号）が表示されるか
  - 応答時間: 5-15秒

- [ ] **FAQ検索機能テスト**
  - 既存のFAQがあれば検索して回答が返るか確認
  - FAQがヒットした場合: 「FAQ」ソースと表示される
  - FAQがヒットしない場合: RAG生成が実行される

### 優先度：低（最適化・改善）

- [ ] **FAQカバレッジ分析**
  - 10-20件のFAQを生成
  - 管理画面でウィンドウ位置を確認
  - PDF全体（158ページ = 約300,000文字）のどこからFAQが生成されているか分析
  - 偏りがある場合、バランス型ウィンドウ選択が機能しているか確認

- [ ] **パフォーマンス確認**
  - ベクトルDB構築時間
  - FAQ生成時間（1件あたり）
  - RAG検索時間
  - Railwayメモリ使用量

---

## トラブルシューティング

### ケース1: デプロイが失敗している

**確認:**
- Deploymentsタブでステータスが「Failed」（赤いX）
- Logsタブでエラーメッセージを確認

**対処:**
1. エラーログをコピー
2. Claude Codeに報告して修正
3. 修正後、手動で再デプロイ（Deployments → Deploy ボタン）

### ケース2: ベクトルDBが構築されない

**症状:**
```
[ERROR] Failed to initialize vector database
FileNotFoundError: Index file not found
```

**対処:**
1. `reference_docs/`フォルダにPDFがあるか確認（GitHub上）
2. `startup_init.py`がリポジトリに含まれているか確認
3. ない場合、ローカルで確認してプッシュ

### ケース3: SyntaxErrorが再発

**症状:**
```
SyntaxError: ...
```

**対処:**
1. エラーメッセージのファイル名と行番号を確認
2. ローカルで該当箇所を修正
3. コミット＆プッシュ
4. Railwayで自動再デプロイ

### ケース4: ウィンドウ情報が表示されない

**症状:**
- FAQ生成後、管理画面でウィンドウ情報が空欄

**原因:**
- 古いデプロイが動いている
- または`window_info`が正しく渡されていない

**対処:**
1. Deploymentsタブで最新のコミット（bfc7736）が動いているか確認
2. 古い場合、最新を手動デプロイ
3. 新しくFAQを生成して再確認

---

## ファイル構成（現在）

### GitHubリポジトリ (main branch)

```
hybrid-rag-system/
├── web_app_hybrid.py           # Flaskアプリ（修正済み）
├── faq_system.py               # FAQシステム（追加、修正済み）
├── startup_init.py             # ベクトルDB自動構築（新規追加）
├── vector_store.py             # ベクトルストア（修正済み）
├── hybrid_rag_system.py        # ハイブリッドRAGコア
├── rag_system.py               # RAGシステム
├── faq_manager.py              # FAQ管理
├── faq_searcher.py             # FAQ検索
├── pdf_processor.py            # PDF処理
├── requirements.txt            # 依存ライブラリ
├── Procfile                    # Railway起動コマンド
├── reference_docs/             # PDFファイル
│   └── 米国ビザ申請の手引きVer.21..pdf  (158ページ)
├── templates/                  # HTMLテンプレート
│   ├── index.html
│   ├── admin_hybrid.html
│   ├── review_pending.html     # ウィンドウ情報表示追加
│   └── auto_generate_faq.html  # 「第2章」→「手引き」修正
└── static/                     # 静的ファイル
```

### 除外ファイル (.gitignore)

```
.env                    # 環境変数
vector_db/              # ベクトルDB（Railway起動時に自動構築）
venv/                   # 仮想環境
__pycache__/            # Pythonキャッシュ
*.log                   # ログファイル
```

---

## コミット履歴（今回のセッション）

1. `8852fc5` - Add work history: Railway deployment 2025-10-23
2. `0d1f63f` - Add auto-build vector database on startup
3. `2ca2e21` - Fix ModuleNotFoundError: Add faq_system.py to repository
4. `63309bf` - Add window info tracking and fix PDF name display
5. `ec4fb15` - Fix SyntaxError: add missing commas and remove duplicate question parameter
6. **`bfc7736` - Fix f-string syntax error: use single quotes inside f-string** ← 最新

---

## 技術メモ

### ウィンドウ選択アルゴリズム

**バランス型ウィンドウ選択:**
- PDFを50文字単位で区切ってウィンドウ候補を生成
- 使用回数が最も少ないウィンドウを優先的に選択
- 同じウィンドウで10回連続重複したら除外
- PDF全体を均等にカバーする設計

**ウィンドウサイズ:**
- 質問用: 500文字（トピック選択用）
- 回答用: 1500文字（詳細情報用）
- オーバーラップ: 質問ウィンドウは回答ウィンドウの中心に配置

**位置情報の記録:**
```python
window_info = "Q範囲: 12500~13000 / A範囲: 12000~13500 / 位置: 12000"
```
- Q範囲: 質問生成に使った文字範囲
- A範囲: 回答生成に使った文字範囲
- 位置: ウィンドウの開始位置（文字数）

**158ページのPDF:**
- 推定総文字数: 約300,000文字
- ウィンドウ候補数: 約6,000個
- ベクトルDBチャンク数: 385個

---

## 環境変数（Railway）

**必須:**
```
CLAUDE_API_KEY=sk-ant-api...
```

**オプション（デフォルト値あり）:**
```
CHUNK_SIZE=800                  # ベクトルDBチャンクサイズ
CHUNK_OVERLAP=100               # チャンクオーバーラップ
SIMILARITY_THRESHOLD=0.93       # 重複判定閾値
TOP_K_CHUNKS=10                 # RAG検索で取得するチャンク数
FINAL_CHUNKS=5                  # 最終的に使用するチャンク数
FAQ_THRESHOLD=0.85              # FAQ検索の類似度閾値
```

---

## 参考リンク

- **GitHub**: https://github.com/kyuwatanabe/hybrid-rag-system.git
- **Railway**: https://railway.app/dashboard (プロジェクト: grateful-libration)
- **デプロイURL**: https://web-production-16d7b.up.railway.app
- **Anthropic Console**: https://console.anthropic.com/

---

## 次回セッション開始時の手順

1. **このファイルを読む**
   - 現在の状況を把握

2. **Railwayデプロイ確認**
   - https://railway.app/dashboard → grateful-libration → Deployments
   - コミット `bfc7736` が「Success」か確認

3. **Logsタブ確認**
   - エラーがないか確認
   - ベクトルDB構築成功ログを確認

4. **アプリ動作確認**
   - https://web-production-16d7b.up.railway.app にアクセス
   - 画面が表示されるか確認

5. **上記チェックリストを実行**
   - 優先度順に確認

6. **問題があれば報告**
   - エラーログをコピーしてClaude Codeに報告

---

**作成者**: Claude Code
**作成日時**: 2025-10-24 15:45 (JST)
**最終更新**: 2025-10-24 15:45 (JST)
**ステータス**: Railwayデプロイ Build中（コミット bfc7736）
